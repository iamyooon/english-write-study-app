-- ESL Writing App - 초기 스키마
-- 
-- 사용법:
-- 1. Supabase 프로젝트 생성 후 SQL Editor에서 실행
-- 2. 또는 Supabase CLI 사용: supabase migration new initial_schema
-- 3. 이 파일을 migrations 폴더에 복사하고 실행

-- 확장 기능 활성화
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 사용자 프로필 테이블
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  grade_level TEXT CHECK (grade_level IN ('elementary_low', 'elementary_high')),
  subscription_type TEXT CHECK (subscription_type IN ('free', 'premium')) DEFAULT 'free',
  subscription_expires_at TIMESTAMPTZ,
  star_gems INTEGER DEFAULT 0,
  parent_email TEXT,
  parent_consent BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Writing 제출 로그 테이블
CREATE TABLE study_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  content_type TEXT CHECK (content_type IN ('text', 'photo')) DEFAULT 'text',
  photo_url TEXT,
  level INTEGER NOT NULL CHECK (level >= 1 AND level <= 10),
  grade_level TEXT NOT NULL CHECK (grade_level IN ('elementary_low', 'elementary_high')),
  moderation_passed BOOLEAN DEFAULT false,
  moderation_details JSONB,
  feedback_id UUID,
  queue_status TEXT CHECK (queue_status IN ('pending', 'processing', 'completed', 'failed')) DEFAULT 'pending',
  queue_position INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  processed_at TIMESTAMPTZ
);

-- AI 피드백 테이블
CREATE TABLE feedbacks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  study_log_id UUID NOT NULL REFERENCES study_logs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  feedback_text TEXT NOT NULL,
  corrected_text TEXT,
  errors JSONB,
  suggestions JSONB,
  word_analysis JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- study_logs의 feedback_id 외래키 추가
ALTER TABLE study_logs ADD CONSTRAINT fk_feedback 
  FOREIGN KEY (feedback_id) REFERENCES feedbacks(id) ON DELETE SET NULL;

-- 캐릭터 커스터마이징 테이블
CREATE TABLE character_customizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  character_data JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

-- 인벤토리 아이템 테이블
CREATE TABLE inventory_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  item_type TEXT CHECK (item_type IN ('character_part', 'decoration', 'theme')),
  item_id TEXT NOT NULL,
  purchased_at TIMESTAMPTZ DEFAULT NOW()
);

-- 결제 로그 테이블
CREATE TABLE payment_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  revenuecat_transaction_id TEXT NOT NULL UNIQUE,
  product_id TEXT NOT NULL,
  purchase_type TEXT CHECK (purchase_type IN ('subscription', 'iap_energy', 'iap_item')),
  amount INTEGER NOT NULL,
  currency TEXT DEFAULT 'KRW',
  status TEXT CHECK (status IN ('pending', 'completed', 'failed', 'refunded')) DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 일일 사용량 추적 테이블
CREATE TABLE daily_usage (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  writing_count INTEGER DEFAULT 0,
  photo_coaching_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, date)
);

-- 인덱스 생성 (성능 최적화)
CREATE INDEX idx_study_logs_user_id_created_at ON study_logs(user_id, created_at DESC);
CREATE INDEX idx_study_logs_queue_status ON study_logs(queue_status) WHERE queue_status = 'pending';
CREATE INDEX idx_feedbacks_user_id_created_at ON feedbacks(user_id, created_at DESC);
CREATE INDEX idx_daily_usage_user_date ON daily_usage(user_id, date DESC);

-- updated_at 자동 업데이트 함수
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 트리거 설정
CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_character_customizations_updated_at BEFORE UPDATE ON character_customizations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_daily_usage_updated_at BEFORE UPDATE ON daily_usage
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
