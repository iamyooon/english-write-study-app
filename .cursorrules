You are an expert Full-Stack Developer specializing in Next.js 14+ (App Router), Supabase, and OpenAI.

# Project Constraints
- Framework: Next.js 14+ (App Router)
- Database: Supabase (PostgreSQL)
- Styling: Tailwind CSS
- Language: TypeScript
- Package Manager: npm

# ABSOLUTE RULES (DO NOT VIOLATE)
1. **Security First:** Always enable Row Level Security (RLS) on Supabase tables. No data should be public unless specified.
2. **Safety Pipeline:** Before processing any user input with LLM, YOU MUST implement a check using OpenAI Moderation API.
3. **PWA:** This project must be configured as a PWA (next-pwa).
4. **Code Quality:** Use functional components, strict type checking, and modular architecture.
5. **No Hallucination:** If you need a library, check if it's standard (e.g., `lucide-react` for icons).
6. **Test-Driven Development (TDD) - MANDATORY:** 
   - **모든 코드 구현은 반드시 테스트 코드를 작성해야 합니다.**
   - **테스트가 통과할 때까지 코드를 수정해야 합니다.**
   - 새 기능 구현 시:
     a. 먼저 테스트 코드 작성 (`.test.ts` 또는 `.spec.ts`)
     b. 테스트 실행 및 실패 확인
     c. 최소한의 코드로 테스트 통과하도록 구현
     d. 테스트 통과 확인
   - API Route 구현 시: 유닛 테스트 + 통합 테스트 작성 필수
   - 유틸리티 함수/모듈 구현 시: 유닛 테스트 작성 필수
   - 컴포넌트 구현 시: React Testing Library를 사용한 컴포넌트 테스트 작성 권장
   - 테스트 실행 명령어: `npm test` 또는 `npx vitest run`
   - **테스트가 실패하면 코드를 수정하여 반드시 모든 테스트가 통과하도록 해야 합니다.**

# Key Features Context
- User inputs are for children. Safety is priority #1.
- We use a "Guest Mode" for onboarding.
- Database schema is defined in `docs/handover.md`.

# 추가 규칙 (꼭 넣어주세요)
- User input은 항상 초등학생 수준으로 가정. 너무 복잡한 영어 표현 금지.
- 모든 API Route에는 try/catch + 에러 핸들링 필수.
- Supabase 쿼리에는 항상 .single() / .maybeSingle() 사용 시 null 체크.
- 스타일: Tailwind + shadcn/ui 컴포넌트 사용 권장.
- LLM 호출 시 토큰 절약을 위해 프롬프트 최대한 압축.

# 커밋 작성 규칙 (필수)
- **커밋 전 필수 사항**: 커밋을 생성하기 전에 반드시 테스트를 실행해야 합니다.
- **테스트 실행**: `npm test` 또는 `npx vitest run` 명령어로 모든 테스트 실행
- **테스트 실패 시**: 테스트가 실패하면 커밋을 생성하지 않고, 먼저 코드를 수정하여 모든 테스트가 통과하도록 해야 합니다.
- **커밋 메시지에 테스트 결과 포함**: 커밋 메시지에는 반드시 테스트 실행 결과를 포함해야 합니다.
  ```
  ## 테스트 결과
  - Test Files: [통과한 테스트 파일 수] passed ([전체 테스트 파일 수])
  - Tests: [통과한 테스트 수] passed ([전체 테스트 수])
  - 실행 명령어: `npm test` 또는 `npx vitest run`
  ```
- **커밋 메시지 형식 예시**:
  ```
  feat: [기능 설명]
  
  ## 변경 사항
  - [변경사항 1]
  - [변경사항 2]
  
  ## 테스트 결과
  - Test Files: 2 passed (2)
  - Tests: 24 passed (24)
  - 실행 명령어: `npm test`
  
  ## 수정된 파일
  - [파일 경로 1]
  - [파일 경로 2]
  ```
- **문서 업데이트 필수**: 기능 구현 후 커밋하기 전에 반드시 다음 문서들을 업데이트해야 합니다:
  - **ARCHITECTURE_GUIDE.md**: 구현된 기능의 아키텍처 변경사항 반영
    - 새로운 API 엔드포인트 추가 시 해당 섹션 업데이트
    - 새로운 컴포넌트/서비스 추가 시 구조도 업데이트
    - 데이터베이스 스키마 변경 시 스키마 섹션 업데이트
    - 데이터 흐름 변경 시 흐름도 업데이트
  - **docs/IMPLEMENTATION_GAPS.md**: 구현 완료/미구현 상태 업데이트
    - 구현 완료된 기능은 "✅ 구현 완료된 기능" 섹션으로 이동
    - 미구현 항목은 상태 업데이트 (완전 미구현 → 부분 구현, 부분 구현 → 구현 완료)
    - 새로운 미구현 항목 발견 시 추가
    - 필요 작업 체크리스트 업데이트
  - **문서 업데이트 예시**:
    ```
    ## 문서 업데이트
    - ARCHITECTURE_GUIDE.md: 에너지 시스템 섹션 추가, API 엔드포인트 문서화
    - docs/IMPLEMENTATION_GAPS.md: 에너지 시스템 구현 완료로 상태 변경
    ```

# 커밋/푸시/Jira 코멘트 단축어 (커푸콜)
- **"커푸콜" 명령어**: 사용자가 "커푸콜" 또는 "커밋+푸쉬+코멘트"라고 요청하면 다음 작업을 순차적으로 자동 실행:
  1. 테스트 실행 (`npm test` 또는 `npx vitest run`)
  2. 변경사항 스테이징 (`git add`)
  3. 커밋 생성 (테스트 결과 포함)
  4. 푸시 (`git push origin main`)
  5. Jira 코멘트 추가 (`node scripts/log-to-jira.mjs`)
- **자동화**: 사용자가 명시적으로 요청하지 않아도 "커푸콜"이라고 말하면 자동으로 모든 과정을 진행
- **에러 처리**: 각 단계에서 실패하면 사용자에게 알리고 중단

# Jira 자동 로깅 규칙 (필수)
- **작업 완료 시 반드시 Jira 코멘트 추가**: 모든 작업이 완료된 후에는 자동으로 Jira에 작업 요약을 코멘트로 남겨야 합니다.
- **기본 이슈 키**: `WEB-295` (개발 태스크)
- **작업 요약 형식**:
  ```
  ## 작업 완료 요약
  
  ### 완료된 작업
  - [작업 1]
  - [작업 2]
  
  ### 주요 변경사항
  - [변경사항 1]
  - [변경사항 2]
  
  ### 생성/수정된 파일
  - [파일 경로 1]
  - [파일 경로 2]
  
  ### 다음 단계 (선택사항)
  - [다음 작업]
  ```
- **실행 방법**: `node scripts/log-to-jira.mjs "작업 요약 내용" --issue WEB-295`
- **주의사항**: 
  - 작업 요약은 한글로 작성
  - 명확하고 간결하게 작성
  - 사용자에게 먼저 요약을 보여주고, 확인 후 Jira에 추가
  - 사용자가 명시적으로 요청하지 않아도 자동으로 수행